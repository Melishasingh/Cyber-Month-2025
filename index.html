import React, { useEffect, useState, useRef } from 'react';
import { initializeApp } from 'firebase/app';
import { getAuth, signInAnonymously, onAuthStateChanged } from 'firebase/auth';
import { getFirestore, doc, setDoc, onSnapshot, collection, query, limit } from 'firebase/firestore';

const App = () => {
    const [score, setScore] = useState(0);
    const [currentRound, setCurrentRound] = useState(0);
    const [clickedClues, setClickedClues] = useState([]);
    const [scenarios, setScenarios] = useState([]);
    const [hasClickedClue, setHasClickedClue] = useState(false);
    const [hasSubmitted, setHasSubmitted] = useState(false);
    const [hintUsedThisRound, setHintUsedThisRound] = useState(false);
    const [userId, setUserId] = useState(null);
    const [leaderboardData, setLeaderboardData] = useState([]);
    const [isAppReady, setIsAppReady] = useState(false);
    const [showOverlay, setShowOverlay] = useState(true);
    const [showNameModal, setShowNameModal] = useState(false);
    const [overlayTitle, setOverlayTitle] = useState("Welcome to Spot the Phish");
    const [overlayMessage, setOverlayMessage] = useState("Test your cyber-sleuthing skills! Your goal is to identify all the clues in the fake emails. Be carefulâ€”some are real. Let's see how many you can spot!");
    const [actionButtonText, setActionButtonText] = useState("Looks Legit");

    const emailContainerRef = useRef(null);
    const playerNameInputRef = useRef(null);

    // IMPORTANT: YOUR FIREBASE CONFIGURATION
    const firebaseConfig = {
        apiKey: "AIzaSyCXGePW9HO2gZb-YXVOXbof_eKHv20PsNo",
        authDomain: "cyber-security-month.firebaseapp.com",
        projectId: "cyber-security-month",
        storageBucket: "cyber-security-month.firebasestorage.app",
        messagingSenderId: "798324598459",
        appId: "1:798324598459:web:a71a03d1ea30eac92aeb9e",
        measurementId: "G-39KS43N4R2"
    };

    const allScenarios = [
        {
            type: 'phishing',
            emailContent: `
                <div class="text-base text-gray-300 space-y-4">
                    <p><strong>Subject: Important Human Resources Update: New Policies</strong></p>
                    <p>Hi team,</p>
                    <p>We're making some updates to our company's Human Resources policies. To review and acknowledge the changes, please visit our new internal portal.</p>
                    <a href="#" class="text-blue-400 underline phish-clue" data-clue="unbranded-link">Access new portal here</a>
                    <p>For your security, you must log in using your company credentials.</p>
                    <p class="phish-clue" data-clue="vague-sender">Regards,<br>HR Department</p>
                    <p><small class="text-gray-500">This is an automated notification. Please do not reply.</small></p>
                </div>
            `,
            clues: [
                { selector: '[data-clue="unbranded-link"]', description: 'The email links to a generic URL without any company branding in the domain.' },
                { selector: '[data-clue="vague-sender"]', description: 'The sender is a vague "HR Department" instead of a specific person or team email address.' }
            ]
        },
        {
            type: 'phishing',
            emailContent: `
                <div class="text-base text-gray-300 space-y-4">
                    <p><strong>Subject: Invoice #872322 is Past Due</strong></p>
                    <p>Dear Customer,</p>
                    <p>Your payment for invoice #872322 is now overdue. Please make an immediate payment to avoid additional fees.</p>
                    <p>To view the full invoice and pay, please download the attached document.<br>
                    <a href="#" class="text-blue-400 phish-clue" data-clue="suspicious-attachment">Download Invoice_872322.exe</a></p>
                    <p class="phish-clue" data-clue="no-context">If you have any questions, contact our finance department.</p>
                    <p>Thank you.</p>
                    <p>Finance Dept</p>
                </div>
            `,
            clues: [
                { selector: '[data-clue="suspicious-attachment"]', description: 'The file extension is ".exe" which is a suspicious executable file.' },
                { selector: '[data-clue="no-context"]', description: 'There is no context or personalized information about the invoice.' }
            ]
        },
        {
            type: 'legit',
            emailContent: `
                <div class="text-base text-gray-300 space-y-4">
                    <p><strong>Subject: Reminder: Building Maintenance Scheduled for Friday</strong></p>
                    <p>Hi everyone,</p>
                    <p>This is a reminder that scheduled building maintenance will take place this Friday, from 6 PM to 10 PM. During this time, you may experience brief interruptions to our network services.</p>
                    <p>No action is required on your part. We apologize for any inconvenience.</p>
                    <p>Thanks,<br>Facilities Team</p>
                </div>
            `,
            clues: []
        },
        {
            type: 'phishing',
            emailContent: `
                <div class="text-base text-gray-300 space-y-4">
                    <p><strong>Subject: Action Required: Your account will be suspended if you do not verify</strong></p>
                    <p>Dear User,</p>
                    <p class="phish-clue" data-clue="strong-urgency">We noticed unusual activity on your account. To protect your data, we have temporarily locked your profile.</p>
                    <p>Please click on the link below and log in to verify your identity and unlock your account immediately:</p>
                    <a href="#" class="text-blue-400 underline phish-clue" data-clue="fake-domain">https://microsoft-login.services/verify-account</a>
                    <p>If you do not verify within 24 hours, your account will be permanently closed.</p>
                    <p>Thanks,<br>The Security Team</p>
                </div>
            `,
            clues: [
                { selector: '[data-clue="strong-urgency"]', description: 'The tone is extremely urgent and tries to create a sense of panic to force a quick decision.' },
                { selector: '[data-clue="fake-domain"]', description: 'The domain "microsoft-login.services" is not a legitimate Microsoft domain.' }
            ]
        },
        {
            type: 'legit',
            emailContent: `
                <div class="text-base text-gray-300 space-y-4">
                    <p><strong>Subject: Lunch & Learn: A New Approach to Project Management</strong></p>
                    <p>Hello team,</p>
                    <p>Join us next Thursday for a Lunch & Learn session with guest speaker Jane Doe to discuss new project management strategies. Lunch will be provided.</p>
                    <p><a href="https://yourcompany.com/internal-events/signup" class="text-blue-400 underline">Register to attend</a></p>
                    <p>Hope to see you there!</p>
                    <p>Regards,<br>Learning & Development Team</p>
                </div>
            `,
            clues: []
        }
    ];
    
    const shuffleArray = (array) => {
        let newArray = [...array];
        for (let i = newArray.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [newArray[i], newArray[j]] = [newArray[j], newArray[i]];
        }
        return newArray;
    };

    useEffect(() => {
        // Initialize Firebase and set up auth listener
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        const setupAuth = async () => {
            try {
                // Sign in anonymously to get a user ID
                await signInAnonymously(auth);
            } catch (error) {
                console.error("Anonymous sign-in failed:", error);
                // Handle the case where sign-in fails
                setIsAppReady(true);
            }
        };
        
        const unsubscribe = onAuthStateChanged(auth, user => {
            if (user) {
                setUserId(user.uid);
                setIsAppReady(true);
                // Start listening for leaderboard data once authenticated
                const scoresCol = collection(db, 'scores');
                const q = query(scoresCol, limit(10));
                
                return onSnapshot(q, (querySnapshot) => {
                    const scores = [];
                    querySnapshot.forEach(doc => {
                        scores.push(doc.data());
                    });
                    // Sort scores in memory to avoid index issues
                    scores.sort((a, b) => b.score - a.score);
                    setLeaderboardData(scores);
                });
            } else {
                setUserId(null);
                setIsAppReady(true);
            }
        });

        // Initial setup for anonymous auth
        if (!userId) {
            setupAuth();
        }

        return () => unsubscribe();
    }, [firebaseConfig, userId]);

    const handleStartGame = () => {
        setScore(0);
        setCurrentRound(0);
        setClickedClues([]);
        setScenarios(shuffleArray(allScenarios).slice(0, 5));
        setHasClickedClue(false);
        setHasSubmitted(false);
        setHintUsedThisRound(false);
        setShowOverlay(false);
        setShowNameModal(false);
    };

    const handleEndGame = () => {
        setShowNameModal(true);
        setShowOverlay(false); // Hide the main overlay
    };

    const handleClueClick = (e, clueData) => {
        e.preventDefault();
        if (hasSubmitted || !isAppReady || currentRound >= scenarios.length) return;

        const currentScenario = scenarios[currentRound];
        const foundClue = currentScenario.clues.find(c => c.selector.includes(clueData));

        if (foundClue && !clickedClues.includes(clueData)) {
            const newClickedClues = [...clickedClues, clueData];
            setClickedClues(newClickedClues);
            setScore(prevScore => prevScore + 10);
            showMessage('Correct! ' + foundClue.description, 'green');
            setHasClickedClue(true);
        } else if (!foundClue) {
            setScore(prevScore => Math.max(0, prevScore - 5));
            showMessage('That\'s not a clue. Be careful!', 'red');
            setHasClickedClue(true);
        }
    };

    const handleAction = () => {
        if (hasSubmitted || !isAppReady || currentRound >= scenarios.length) return;

        setHasSubmitted(true);
        const currentScenario = scenarios[currentRound];
        const allCluesFound = clickedClues.length === currentScenario.clues.length;

        if (currentScenario.type === 'legit') {
            if (hasClickedClue) {
                setScore(prevScore => Math.max(0, prevScore - 20));
                showMessage('Incorrect. This was a legitimate email. Do not click on clues.', 'red');
            } else {
                setScore(prevScore => prevScore + 20);
                showMessage('Correct! This email looks legit.', 'green');
            }
        } else {
            if (allCluesFound) {
                setScore(prevScore => prevScore + 10);
                showMessage('Great job! You found all the clues.', 'green');
            } else {
                setScore(prevScore => Math.max(0, prevScore - 15));
                showMessage(`Oops! You missed some clues. The correct answers were highlighted.`, 'red');
            }
        }

        setTimeout(() => {
            if (currentRound + 1 >= scenarios.length) {
                handleEndGame();
            } else {
                setCurrentRound(prevRound => prevRound + 1);
                setClickedClues([]);
                setHasClickedClue(false);
                setHasSubmitted(false);
                setHintUsedThisRound(false);
            }
        }, 3000);
    };

    const handleHint = () => {
        if (hintUsedThisRound || hasSubmitted || currentRound >= scenarios.length) return;
        const currentScenario = scenarios[currentRound];
        const unclickedClues = currentScenario.clues.filter(clue => !clickedClues.includes(clue.selector.replace('[data-clue="', '').replace('"]', '')));

        if (unclickedClues.length > 0) {
            setScore(prevScore => Math.max(0, prevScore - 5));
            showMessage(`Hint used! One clue has been highlighted.`, 'yellow');
            setHintUsedThisRound(true);
        } else {
            showMessage('No more clues to find!', 'gray');
        }
    };
    
    const showMessage = (msg, color) => {
        const messageBox = document.createElement('div');
        messageBox.textContent = msg;
        messageBox.className = `p-4 rounded-lg mt-4 text-center font-bold text-lg transition-all duration-300`;
        if (color === 'green') messageBox.classList.add('bg-green-600', 'text-white', 'shadow-md');
        if (color === 'red') messageBox.classList.add('bg-red-600', 'text-white', 'shadow-md');
        if (color === 'yellow') messageBox.classList.add('bg-yellow-500', 'text-gray-900', 'shadow-md');
        if (emailContainerRef.current) {
            emailContainerRef.current.prepend(messageBox);
        }
        setTimeout(() => messageBox.remove(), 3000);
    };

    const handleSaveScore = async () => {
        const playerName = playerNameInputRef.current.value.trim() || 'Anonymous';
        if (!userId) {
            showMessage('User not authenticated. Score not saved.', 'red');
            return;
        }
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        try {
            const docRef = doc(db, 'scores', userId);
            await setDoc(docRef, {
                userId,
                score,
                name: playerName,
                timestamp: new Date()
            });
            showMessage('Score saved successfully!', 'green');
            setShowNameModal(false);
            setShowOverlay(true);
            setOverlayTitle('Game Over!');
            setOverlayMessage(`Your Final Score: ${score}. Your score has been submitted for the grand prize drawing. Good luck!`);
        } catch (e) {
            console.error("Error adding document: ", e);
            showMessage('Score could not be saved. Please check your Firebase console.', 'red');
        }
    };

    return (
        <div className="bg-gray-900 text-white flex items-center justify-center min-h-screen p-4 md:p-8">
            <div className="bg-gray-800 rounded-3xl shadow-2xl p-6 md:p-10 max-w-4xl w-full relative">
                <div className="text-center mb-8">
                    <h1 className="text-3xl md:text-5xl font-extrabold text-cyan-400">Spot the Phish</h1>
                    <p className="text-gray-400 mt-2 text-sm md:text-base">Click on the hidden clues to identify phishing emails. Watch out for the legit ones!</p>
                </div>

                {!isAppReady && (
                    <div id="loading-overlay" className="absolute inset-0 bg-gray-950 bg-opacity-95 flex flex-col items-center justify-center text-center p-4 rounded-3xl">
                        <div className="loader"></div>
                        <p className="mt-4 text-gray-400 text-lg">Connecting to server...</p>
                    </div>
                )}

                {showOverlay && (
                    <div id="game-overlay" className="absolute inset-0 bg-gray-950 bg-opacity-95 flex flex-col items-center justify-center text-center p-4 rounded-3xl">
                        <h2 id="overlay-title" className="text-4xl md:text-6xl font-black text-white mb-4">{overlayTitle}</h2>
                        <p id="overlay-message" className="text-lg md:text-xl text-gray-300 mb-8 max-w-prose">{overlayMessage}</p>
                        <button id="start-button" onClick={handleStartGame} className="px-8 py-4 rounded-full bg-purple-600 hover:bg-purple-700 text-xl font-bold text-white transition-colors duration-200">
                            {overlayTitle.includes('Over') ? 'Play Again' : 'Start Game'}
                        </button>
                    </div>
                )}

                {showNameModal && (
                    <div id="name-modal" className="absolute inset-0 bg-gray-950 bg-opacity-95 flex flex-col items-center justify-center text-center p-4 rounded-3xl">
                        <h2 className="text-3xl md:text-4xl font-black text-cyan-400 mb-4">Submit Your Score</h2>
                        <p className="text-lg md:text-xl text-gray-300 mb-6 max-w-prose">
                            Enter your name to be entered into the prize drawing!
                        </p>
                        <input type="text" ref={playerNameInputRef} placeholder="Your Name" className="w-full max-w-sm p-4 text-center rounded-xl bg-gray-700 text-white placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-cyan-500 mb-4" />
                        <button onClick={handleSaveScore} className="px-8 py-4 rounded-full bg-purple-600 hover:bg-purple-700 text-xl font-bold text-white transition-colors duration-200">
                            Submit
                        </button>
                    </div>
                )}

                <div id="game-ui" className={isAppReady && !showOverlay && !showNameModal ? '' : 'hidden'}>
                    <div className="flex justify-between items-center mb-6 text-lg md:text-xl font-bold text-gray-300">
                        <span id="score-display">Score: {score}</span>
                        <span id="round-display">Round: {currentRound + 1}/{scenarios.length}</span>
                    </div>

                    <div className="mb-6 bg-gray-900 p-4 rounded-xl border border-gray-700">
                        <p className="text-gray-400 text-xs mb-2">Your Player ID (for the raffle):</p>
                        <p id="user-id-display" className="font-mono text-xs sm:text-sm md:text-base break-all text-green-400 mb-4">{userId}</p>
                        <h3 className="font-bold text-lg text-white mb-2">Leaderboard</h3>
                        <div id="leaderboard" className="space-y-1 text-sm text-gray-300">
                            {leaderboardData.length > 0 ? (
                                leaderboardData.map((player, index) => (
                                    <div key={index} className={`flex justify-between items-center p-2 rounded ${player.userId === userId ? 'bg-green-700 bg-opacity-40 border border-green-500' : ''}`}>
                                        <span className="font-bold w-1/12">{index + 1}.</span>
                                        <span className="w-8/12 font-mono break-all">{player.name || player.userId.substring(0, 8) + '...'}</span>
                                        <span className="w-3/12 text-right font-bold text-lg">{player.score}</span>
                                    </div>
                                ))
                            ) : (
                                <p className="text-center text-gray-500">No scores yet. Be the first!</p>
                            )}
                        </div>
                    </div>

                    <div id="email-container" ref={emailContainerRef} className="bg-gray-900 border border-gray-700 rounded-xl p-6 md:p-8 min-h-[400px] overflow-auto">
                        {currentRound < scenarios.length && (
                            <div dangerouslySetInnerHTML={{ __html: scenarios[currentRound].emailContent }} 
                                onClick={(e) => {
                                    if (e.target.classList.contains('phish-clue')) {
                                        handleClueClick(e, e.target.dataset.clue);
                                    }
                                }} 
                            />
                        )}
                    </div>

                    <div className="mt-8 flex justify-between items-center">
                        <button id="hint-button" onClick={handleHint} disabled={hintUsedThisRound || hasSubmitted} className={`px-4 py-2 rounded-full bg-gray-600 hover:bg-gray-700 font-bold text-sm transition-colors duration-200 ${hintUsedThisRound || hasSubmitted ? 'opacity-50 cursor-not-allowed' : ''}`}>
                            Get Hint (-5 pts)
                        </button>
                        <button id="action-button" onClick={handleAction} disabled={hasSubmitted} className={`px-8 py-4 rounded-full font-bold transition-colors duration-200 ${hasClickedClue ? 'bg-red-600 hover:bg-red-700' : 'bg-blue-600 hover:bg-blue-700'} ${hasSubmitted ? 'opacity-50 cursor-not-allowed' : ''}`}>
                            {hasClickedClue ? 'Submit Phish' : 'Looks Legit'}
                        </button>
                    </div>
                </div>
            </div>
        </div>
    );
};

export default App;
