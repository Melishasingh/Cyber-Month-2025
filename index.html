import React, { useState, useEffect } from 'react';
import { initializeApp } from 'firebase/app';
import {
    getAuth,
    signInWithCustomToken,
    onAuthStateChanged,
    signInAnonymously
} from 'firebase/auth';
import {
    getFirestore,
    collection,
    addDoc,
    query,
    onSnapshot,
    serverTimestamp
} from 'firebase/firestore';

// Game data with realistic phishing emails
const scenarios = [
    {
        id: 1,
        isPhish: true,
        type: "Email",
        sender: "support@amazon-notificaitions.com",
        subject: "Your Recent Order Is On Hold",
        phishElements: ["sender", "urgency", "link"],
        bodyParts: [
            { type: 'text', content: `<p class="my-4">Dear Valued Customer,</p>` },
            { type: 'text', content: `<p class="my-4" data-phish-type="urgency">There was an issue processing your last order. To avoid cancellation, please confirm your payment information through the link below.</p>` },
            {
                type: 'link',
                content: 'Confirm Payment Details',
                target: 'https://www.amazon-update.biz/login',
                clue: "The link points to a suspicious domain that is not amazon.com."
            },
            { type: 'text', content: `<p class="my-4">Thank you for your business.</p><p>The Amazon Team</p>` },
        ],
        clues: [
            "The sender's email address has a typo: 'notificaitions' instead of 'notifications'.",
            "The message creates a false sense of urgency ('on hold', 'avoid cancellation').",
            "The link points to a suspicious domain that is not amazon.com."
        ]
    },
    {
        id: 2,
        isPhish: true,
        type: "Email",
        sender: "secure@paypal.com",
        subject: "New Device Login Detected",
        phishElements: ["link", "subject-urgency"],
        bodyParts: [
            { type: 'text', content: `<p class="my-4">Hello,</p>` },
            { type: 'text', content: `<p class="my-4" data-phish-type="urgency">A new device has logged in to your PayPal account. If this was not you, please secure your account immediately by clicking the link below:</p>` },
            {
                type: 'link',
                content: 'Secure Your Account Now',
                target: 'https://bit.ly/3xY8aB5',
                clue: "The link uses a URL shortener, which can hide a malicious destination."
            },
            { type: 'text', content: `<p class="my-4">Thank you,<br>The PayPal Security Team</p>` }
        ],
        clues: [
            "The email sender appears legitimate, but the link uses a URL shortener to hide a malicious link.",
            "The subject line creates a sense of panic and urgency to trick you into clicking without thinking.",
            "Legitimate security alerts from PayPal would direct you to the official site, not a third-party link shortener."
        ]
    },
    {
        id: 3,
        isPhish: false,
        type: "Email",
        sender: "noreply@linkedin.com",
        subject: "Your Network Has Mentioned You in a Post",
        phishElements: [],
        bodyParts: [
            { type: 'text', content: `<p class="my-4">Hi John,</p>` },
            { type: 'text', content: `<p class="my-4">Your connection, Sarah, mentioned you in a new post. View the conversation and join in!</p>` },
            { type: 'text', content: `
                <p class="my-4 text-center">
                    <a href="#" class="inline-block px-6 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">View Post</a>
                </p>
            `},
            { type: 'text', content: `<p class="my-4">Best regards,<br>LinkedIn</p>` }
        ],
        clues: [
            "The sender email 'noreply@linkedin.com' is a legitimate LinkedIn domain.",
            "The tone is informative and friendly, not urgent or threatening.",
            "The email's content is specific (mentions a connection by name) and provides a clear, verifiable action."
        ]
    },
    {
        id: 4,
        isPhish: true,
        type: "SMS",
        sender: "555-0199",
        subject: "URGENT: Your package is delayed",
        phishElements: ["sender", "urgency", "link"],
        bodyParts: [
            { type: 'text', content: `FRM: FEDEX<br>MSG: <span class="cursor-pointer" data-phish-type="urgency">Your package has been delayed. To reschedule delivery, click the following link:<br></span> ` },
            {
                type: 'link',
                content: 'fedex-delivery-status.com',
                target: 'https://phishing-site.com',
                clue: "The message comes from a generic phone number, not an official one."
            }
        ],
        clues: [
            "The message comes from a generic phone number, not an official one.",
            "The tone is urgent and threatening, designed to make you act without thinking.",
            "The domain in the link is not the official fedex.com website."
        ]
    },
    {
        id: 5,
        isPhish: false,
        type: "Email",
        sender: "no-reply@microsoft.com",
        subject: "Your Microsoft account has been updated",
        phishElements: [],
        bodyParts: [
            { type: 'text', content: `<p class="my-4">Dear User,</p>` },
            { type: 'text', content: `<p class="my-4">This is a confirmation that your Microsoft account settings have been updated. If you did not make this change, you can review your recent activity in your account settings.</p>` },
            { type: 'text', content: `<p class="my-4">Thank you,<br>The Microsoft Team</p>` }
        ],
        clues: [
            "The email is sent from a legitimate Microsoft domain.",
            "It is a simple confirmation, not an urgent alert, and provides a clear path to verify activity.",
            "There are no links asking for personal information or demanding immediate action."
        ]
    }
];

// Firebase setup
const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

let app, db, auth;
if (firebaseConfig) {
    app = initializeApp(firebaseConfig);
    db = getFirestore(app);
    auth = getAuth(app);
}

// Main App component
const App = () => {
    const [gameState, setGameState] = useState('menu');
    const [currentScenario, setCurrentScenario] = useState(null);
    const [score, setScore] = useState(0);
    const [feedback, setFeedback] = useState({ message: '', isCorrect: null, clues: [] });
    const [leaderboard, setLeaderboard] = useState([]);
    const [userId, setUserId] = useState(null);
    const [authReady, setAuthReady] = useState(false);
    const [showLeaderboard, setShowLeaderboard] = useState(false);
    const [currentScenarioIndex, setCurrentScenarioIndex] = useState(0);
    const [playerName, setPlayerName] = useState('');
    const [phishFound, setPhishFound] = useState([]);
    const [isAnsweredCorrectly, setIsAnsweredCorrectly] = useState(false);

    // Firebase Auth and Firestore setup
    useEffect(() => {
        if (!auth || !db) return;

        const unsubscribe = onAuthStateChanged(auth, async (user) => {
            if (!user) {
                try {
                    if (typeof __initial_auth_token !== 'undefined') {
                        await signInWithCustomToken(auth, __initial_auth_token);
                    } else {
                        await signInAnonymously(auth);
                    }
                } catch (error) {
                    console.error("Error signing in:", error);
                }
                return;
            }
            setUserId(user.uid);
            setAuthReady(true);

            const leaderboardPath = `/artifacts/${appId}/public/data/leaderboard`;
            const q = collection(db, leaderboardPath);

            const unsubscribeLeaderboard = onSnapshot(q, (querySnapshot) => {
                const scores = [];
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    scores.push({
                        id: doc.id,
                        username: data.username,
                        score: data.score,
                        userId: data.userId
                    });
                });
                scores.sort((a, b) => b.score - a.score);
                setLeaderboard(scores);
            }, (error) => {
                console.error("Error fetching leaderboard:", error);
            });
            return () => {
                unsubscribeLeaderboard();
            };
        });
        return () => {
            unsubscribe();
        };
    }, [auth, db]);

    const startGame = () => {
        setGameState('name_prompt');
    };

    const handleNameSubmit = (e) => {
        e.preventDefault();
        if (playerName.trim() === '') return;
        setScore(0);
        setGameState('playing');
        setCurrentScenarioIndex(0);
        setCurrentScenario(scenarios[0]);
        setFeedback({ message: '', isCorrect: null, clues: [] });
    };

    const handlePlayerAction = (actionType) => {
        if (gameState !== 'playing') return;

        let isCorrect = false;
        let pointsChange = 0;
        let feedbackMessage = '';
        
        if (currentScenario.isPhish) {
            if (currentScenario.phishElements.includes(actionType) && !phishFound.includes(actionType)) {
                isCorrect = true;
                pointsChange = 5;
                setPhishFound([...phishFound, actionType]);
                feedbackMessage = phishFound.length === 0 ? `Correct! +${pointsChange}pts.` : `Correct again! +${pointsChange}pts.`;
                setFeedback({ message: feedbackMessage, isCorrect: true, clues: [] });
            } else if (actionType === 'legit') {
                isCorrect = false;
                pointsChange = -1;
                feedbackMessage = "Incorrect! -1pt. This is a phish.";
                setFeedback({ message: feedbackMessage, isCorrect: false, clues: currentScenario.clues });
            } else {
                 isCorrect = false;
                 pointsChange = -1;
                 feedbackMessage = "Incorrect. -1pt.";
                 setFeedback({ message: feedbackMessage, isCorrect: false, clues: [] });
            }
        } else { // Legitimate scenario
            if (actionType === 'legit') {
                isCorrect = true;
                pointsChange = 5;
                feedbackMessage = `Correct! +${pointsChange}pts.`;
                setFeedback({ message: feedbackMessage, isCorrect: true, clues: [] });
            } else {
                isCorrect = false;
                pointsChange = -1;
                feedbackMessage = "Incorrect. -1pt.";
                setFeedback({ message: feedbackMessage, isCorrect: false, clues: [] });
            }
        }
        
        setScore(prevScore => Math.max(0, prevScore + pointsChange));
        if (isCorrect && currentScenario.isPhish && phishFound.length === currentScenario.phishElements.length) {
            setHasAnsweredCorrectly(true);
        } else if (isCorrect && !currentScenario.isPhish) {
            setHasAnsweredCorrectly(true);
        } else {
            setHasAnsweredCorrectly(false);
        }
    };

    const goToNextScenario = () => {
        setPhishFound([]);
        setHasAnsweredCorrectly(false);
        const nextIndex = currentScenarioIndex + 1;
        if (nextIndex < scenarios.length) {
            setCurrentScenarioIndex(nextIndex);
            setCurrentScenario(scenarios[nextIndex]);
            setFeedback({ message: '', isCorrect: null, clues: [] });
        } else {
            handleGameOver();
        }
    };

    const handleGameOver = async () => {
        setGameState('game_over');
        if (!authReady || !userId || !db) return;

        try {
            const leaderboardPath = `/artifacts/${appId}/public/data/leaderboard`;
            await addDoc(collection(db, leaderboardPath), {
                userId: userId,
                username: playerName,
                score: score,
                timestamp: serverTimestamp()
            });
        } catch (e) {
            console.error("Error adding score to leaderboard:", e);
        }
    };

    const resetGame = () => {
        setGameState('menu');
        setScore(0);
        setCurrentScenario(null);
        setCurrentScenarioIndex(0);
        setFeedback({ message: '', isCorrect: null, clues: [] });
        setPhishFound([]);
        setHasAnsweredCorrectly(false);
    };

    const renderEmailContent = () => {
        if (!currentScenario || !currentScenario.bodyParts) return null;

        return currentScenario.bodyParts.map((part, index) => {
            let partClass = 'cursor-pointer'; 
            
            return (
                <span
                    key={index}
                    className={partClass}
                    dangerouslySetInnerHTML={{ __html: part.content }}
                    onClick={() => {
                        const isLink = part.type === 'link';
                        const isUrgency = part.type === 'text' && part.content.includes("issue processing");
                        
                        if (isLink) {
                            handlePlayerAction('link');
                        } else if (isUrgency) {
                            handlePlayerAction('urgency');
                        } else {
                            handlePlayerAction('body-text');
                        }
                    }}
                >
                </span>
            );
        });
    };

    const renderGameScreen = () => {
        const canAdvance = (currentScenario.isPhish && phishFound.length === currentScenario.phishElements.length) || (!currentScenario.isPhish && feedback.isCorrect);
        
        return (
            <div className="relative flex flex-col items-center p-8 bg-[#001f3f] rounded-3xl shadow-lg w-full max-w-2xl transform transition-all duration-300 border-4 border-[#00e5e5]">
                <div className="absolute top-0 left-1/2 -translate-x-1/2 w-48 h-3 bg-[#00e5e5] rounded-b-xl animate-pulse"></div>
                <div className="w-full flex justify-between items-center mb-6 text-xl font-bold text-[#64b5f6] border-b-2 border-[#64b5f6] pb-4">
                    <span>SCORE: {score}</span>
                </div>
                {currentScenario && (
                    <div className="w-full p-6 border-2 border-[#64b5f6] rounded-2xl bg-[#002b5c] shadow-inner text-white">
                        <div
                            className={`p-3 mb-4 bg-[#002244] rounded-md cursor-pointer border border-transparent hover:border-[#64b5f6]`}
                            onClick={() => handlePlayerAction('sender')}
                        >
                            <p className="font-bold text-[#81d4fa]">FROM: <span className="text-white">{currentScenario.sender}</span></p>
                            <p className="font-bold text-[#81d4fa]">SUBJ: <span className="text-white cursor-pointer" onClick={() => handlePlayerAction('subject-urgency')}>
                                {currentScenario.subject}
                            </span></p>
                        </div>
                        <div className="text-white leading-relaxed text-sm bg-[#002244] p-4 border border-[#64b5f6] rounded-lg overflow-y-auto max-h-96">
                            {renderEmailContent()}
                        </div>
    
                        {feedback.message && (
                            <div className={`mt-6 p-4 text-center font-semibold rounded-lg transition-all duration-500 transform ${feedback.isCorrect ? 'bg-green-600 text-white' : 'bg-red-600 text-white'}`}>
                                {feedback.message}
                            </div>
                        )}
                        {feedback.isCorrect === false && currentScenario.isPhish && (
                            <div className="mt-4 bg-[#001f3f] p-4 rounded-lg border border-[#64b5f6] text-[#b3e5fc]">
                                <h3 className="font-bold mb-2">CLUES:</h3>
                                <ul className="list-disc list-inside text-[#e1f5fe] text-sm">
                                    {currentScenario.clues.map((clue, index) => (
                                        <li key={index}>{clue}</li>
                                    ))}
                                </ul>
                            </div>
                        )}
                    </div>
                )}
                <div className="mt-8 flex space-x-4">
                    <button
                        onClick={goToNextScenario}
                        className={`flex items-center justify-center px-8 py-3 bg-green-600 text-white font-bold rounded-full shadow-lg hover:bg-green-700 transition-all transform hover:scale-105 active:scale-95 text-lg`}
                    >
                        <span className="font-sans">Next Creature</span>
                    </button>
                    <button
                        onClick={() => handlePlayerAction('legit')}
                        className={`flex items-center justify-center px-8 py-3 bg-[#64b5f6] text-[#001f3f] font-bold rounded-full shadow-lg hover:bg-[#42a5f5] transition-all transform hover:scale-105 active:scale-95 text-lg`}
                    >
                        <span className="font-sans">This is Legitimate</span>
                    </button>
                </div>
                <div className="mt-6 text-sm text-[#004e8a]">
                    DIVER ID: <span className="font-mono text-xs text-[#64b5f6]">{userId || 'LOADING...'}</span>
                </div>
            </div>
        );
    };

    const renderNamePrompt = () => (
        <div className="flex flex-col items-center p-10 bg-[#001f3f] rounded-3xl shadow-lg w-full max-w-md text-center text-[#64b5f6] border-4 border-[#00e5e5]">
            <h2 className="text-3xl font-extrabold mb-4 font-sans">:: DIVER_ID REQUIRED ::</h2>
            <p className="text-gray-400 mb-6 font-sans">Enter your name to be entered into the raffle for a prize! Good luck, diver!</p>
            <form onSubmit={handleNameSubmit} className="w-full">
                <input
                    type="text"
                    value={playerName}
                    onChange={(e) => setPlayerName(e.target.value)}
                    placeholder="Diver Name"
                    className="w-full px-4 py-3 bg-[#002b5c] text-[#b3e5fc] font-sans rounded-lg border border-[#64b5f6] focus:outline-none focus:ring-2 focus:ring-[#00e5e5] placeholder-[#64b5f6]"
                    required
                />
                <button
                    type="submit"
                    className="mt-6 w-full px-8 py-4 bg-[#64b5f6] text-[#001f3f] font-bold text-lg rounded-full shadow-lg hover:bg-[#42a5f5] transition-all transform hover:scale-105 active:scale-95 animate-pulse"
                >
                    <span className="font-sans">BEGIN DIVE</span>
                </button>
            </form>
        </div>
    );

    const renderLeaderboard = () => (
        <div className="flex flex-col items-center p-8 bg-[#001f3f] rounded-3xl shadow-lg w-full max-w-lg mt-6 text-[#64b5f6] border-4 border-[#00e5e5]">
            <h2 className="text-4xl font-extrabold mb-6 font-sans">:: DIVER_LOGS ::</h2>
            <div className="w-full text-center">
                {leaderboard.length > 0 ? (
                    <table className="w-full text-left table-auto border-collapse font-sans">
                        <thead>
                            <tr className="bg-[#002b5c] text-[#81d4fa]">
                                <th className="px-4 py-3 font-semibold">RANK</th>
                                <th className="px-4 py-3 font-semibold">CALLSIGN</th>
                                <th className="px-4 py-3 font-semibold text-right">SCORE</th>
                            </tr>
                        </thead>
                        <tbody>
                            {leaderboard.slice(0, 10).map((entry, index) => (
                                <tr key={entry.id} className={`${index % 2 === 0 ? 'bg-[#002244]' : 'bg-[#001f3f]'} text-white hover:bg-[#002b5c] transition-colors`}>
                                    <td className="px-4 py-3 text-[#b3e5fc] font-bold">{index + 1}</td>
                                    <td className="px-4 py-3 text-sm text-[#e1f5fe]">{entry.username}</td>
                                    <td className="px-4 py-3 font-bold text-right text-[#b3e5fc]">{entry.score}</td>
                                </tr>
                            ))}
                        </tbody>
                    </table>
                ) : (
                    <p className="text-center text-[#81d4fa] py-8 font-sans">NO LOGS FOUND.</p>
                )}
            </div>
            <button onClick={() => setShowLeaderboard(false)} className="mt-8 px-8 py-4 bg-[#64b5f6] text-[#001f3f] font-bold rounded-full shadow-lg hover:bg-[#42a5f5] transition-all transform hover:scale-105 active:scale-95 font-sans">
                <span className="font-sans">RETURN TO SUB</span>
            </button>
        </div>
    );

    const renderGameOverScreen = () => (
        <div className="flex flex-col items-center p-10 bg-[#001f3f] rounded-3xl shadow-lg w-full max-w-md text-center text-[#64b5f6] border-4 border-[#00e5e5]">
            <h2 className="text-4xl font-bold text-[#b3e5fc] mb-4 font-sans">:: DIVE COMPLETE ::</h2>
            <p className="text-2xl text-[#81d4fa] mb-2 font-sans">FINAL SCORE:</p>
            <p className="text-6xl font-extrabold text-[#00e5e5] mb-8 font-sans">{score}</p>
            <button
                onClick={resetGame}
                className="px-8 py-4 bg-[#64b5f6] text-[#001f3f] font-bold rounded-full shadow-lg hover:bg-[#42a5f5] transition-all transform hover:scale-105 active:scale-95"
            >
                <span className="font-sans">BEGIN NEW DIVE</span>
            </button>
            <button
                onClick={() => setShowLeaderboard(true)}
                className="mt-4 px-8 py-4 bg-[#002b5c] text-[#64b5f6] font-bold rounded-full shadow-lg hover:bg-[#004e8a] transition-colors transform hover:scale-105 active:scale-95"
            >
                <span className="font-sans">VIEW LOGS</span>
            </button>
        </div>
    );

    return (
        <div className="min-h-screen bg-[#000d1a] text-white flex flex-col items-center justify-center p-4">
            <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet" />
            <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" />
            <style>
                {`
                body { font-family: 'Roboto', sans-serif; }
                .animate-pulse { animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
                @keyframes pulse {
                    0%, 100% { opacity: 1; }
                    50% { opacity: .5; }
                }
                .phish-target { text-shadow: 0 0 5px #ff5252, 0 0 10px #ff5252; }
                .phish-target:hover { color: #ef4444; }
                .cursor-pointer { cursor: pointer; }
                .animate-pop {
                    animation: pop-up 0.5s ease-out forwards;
                }
                @keyframes pop-up {
                    0% {
                        transform: scale(0);
                        opacity: 0;
                    }
                    100% {
                        transform: scale(1);
                        opacity: 1;
                    }
                }
                .animate-fish-float {
                    animation: fish-float 2s infinite ease-in-out;
                }
                @keyframes fish-float {
                    0%, 100% { transform: translateY(0px) rotate(0deg); }
                    50% { transform: translateY(-10px) rotate(5deg); }
                }
                .animate-crab-scuttle {
                    animation: crab-scuttle 2s infinite ease-in-out;
                }
                @keyframes crab-scuttle {
                    0%, 100% { transform: translateX(0px); }
                    50% { transform: translateX(5px); }
                }
                .pufferfish-happy {
                    transform-origin: 50% 50%;
                }
                .pufferfish-eye {
                    animation: blink 3s infinite;
                }
                @keyframes blink {
                    0%, 20%, 40%, 60%, 80%, 100% { transform: scaleY(1); }
                    10%, 30%, 50%, 70%, 90% { transform: scaleY(0.1); }
                }
                .crab-angry {
                    transform-origin: 50% 50%;
                }
                .crab-claw-left, .crab-claw-right {
                    transform-origin: 50% 50%;
                    animation: claw-wiggle 1s infinite ease-in-out;
                }
                @keyframes claw-wiggle {
                    0%, 100% { transform: rotate(0deg); }
                    50% { transform: rotate(15deg); }
                }
                `}
            </style>
            <h1 className="text-5xl font-extrabold mb-8 text-[#00e5e5] drop-shadow-lg">
                <i className="fas fa-water mr-4 text-[#00e5e5]"></i>SPOT THE PHISH
            </h1>

            {showLeaderboard ? renderLeaderboard() : (
                <>
                    {gameState === 'menu' && (
                        <div className="flex flex-col items-center p-10 bg-[#001f3f] rounded-3xl shadow-lg w-full max-w-md text-center text-[#64b5f6] border-4 border-[#00e5e5]">
                            <h2 className="text-3xl font-extrabold mb-4 font-sans">BEGIN SUBMERGED OPS</h2>
                            <p className="text-gray-400 mb-8 font-sans">YOUR MISSION: IDENTIFY THE MALICIOUS CREATURES LURKING IN THE DEEP.</p>
                            <button
                                onClick={startGame}
                                className="px-10 py-5 bg-[#64b5f6] text-[#001f3f] font-bold text-lg rounded-full shadow-lg hover:bg-[#42a5f5] transition-all transform hover:scale-105 active:scale-95 animate-pulse"
                            >
                                <span className="font-sans">BEGIN DIVE</span>
                            </button>
                            <button
                                onClick={() => setShowLeaderboard(true)}
                                className="mt-6 px-8 py-4 bg-[#002b5c] text-[#64b5f6] font-bold rounded-full shadow-lg hover:bg-[#004e8a] transition-colors transform hover:scale-105 active:scale-95"
                            >
                                <span className="font-sans">VIEW LOGS</span>
                            </button>
                            <div className="mt-6 text-xs text-[#004e8a]">
                                DIVER ID: <span className="font-mono text-xs text-[#64b5f6]">{userId || 'LOADING...'}</span>
                            </div>
                        </div>
                    )}

                    {gameState === 'name_prompt' && renderNamePrompt()}
                    {gameState === 'playing' && renderGameScreen()}
                    {gameState === 'game_over' && renderGameOverScreen()}
                </>
            )}
        </div>
    );
};

export default App;
