<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spot the Phish</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;800&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .phish-clue { cursor: pointer; transition: all 0.3s ease; }
        .phish-clue:hover { text-shadow: 0 0 2px rgba(255, 255, 255, 0.5); transform: scale(1.02); }
        .correct-answer { background-color: rgba(0, 255, 0, 0.3); border-bottom: 2px solid green; }
        .incorrect-answer { background-color: rgba(255, 0, 0, 0.3); border-bottom: 2px solid red; }
        .hint-highlight { background-color: rgba(255, 255, 0, 0.3); border-bottom: 2px solid yellow; }
        .loader { border: 4px solid #f3f3f3; border-radius: 50%; border-top: 4px solid #3498db; width: 40px; height: 40px; -webkit-animation: spin 2s linear infinite; animation: spin 2s linear infinite; }
        @-webkit-keyframes spin { 0% { -webkit-transform: rotate(0deg); } 100% { -webkit-transform: rotate(360deg); } }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-gray-900 text-white flex items-center justify-center min-h-screen p-4 md:p-8">

    <!-- Game Container -->
    <div class="bg-gray-800 rounded-3xl shadow-2xl p-6 md:p-10 max-w-4xl w-full relative">

        <!-- Game Header -->
        <div class="text-center mb-8">
            <h1 class="text-3xl md:text-5xl font-extrabold text-cyan-400">Spot the Phish</h1>
            <p class="text-gray-400 mt-2 text-sm md:text-base">Click on the hidden clues to identify phishing emails. Watch out for the legit ones!</p>
        </div>

        <!-- Game Interface -->
        <div id="game-ui" class="hidden">
            <!-- Score and Round Tracker -->
            <div class="flex justify-between items-center mb-6 text-lg md:text-xl font-bold text-gray-300">
                <span id="score-display">Score: 0</span>
                <span id="round-display">Round: 1/5</span>
            </div>

            <!-- User ID and Leaderboard -->
            <div class="mb-6 bg-gray-900 p-4 rounded-xl border border-gray-700">
                <p class="text-gray-400 text-xs mb-2">Your Player ID (for the raffle):</p>
                <p id="user-id-display" class="font-mono text-xs sm:text-sm md:text-base break-all text-green-400 mb-4"></p>
                <h3 class="font-bold text-lg text-white mb-2">Leaderboard</h3>
                <div id="leaderboard" class="space-y-1 text-sm text-gray-300">
                    <p class="text-center text-gray-500">Loading leaderboard...</p>
                </div>
            </div>

            <!-- Email Display Area -->
            <div id="email-container" class="bg-gray-900 border border-gray-700 rounded-xl p-6 md:p-8 min-h-[400px] overflow-auto">
                <!-- Content will be injected here by JavaScript -->
            </div>

            <!-- Action Buttons -->
            <div class="mt-8 flex justify-between items-center">
                <button id="hint-button" class="px-4 py-2 rounded-full bg-gray-600 hover:bg-gray-700 font-bold text-sm transition-colors duration-200">
                    Get Hint (-5 pts)
                </button>
                <button id="action-button" class="px-8 py-4 rounded-full bg-blue-600 hover:bg-blue-700 font-bold transition-colors duration-200">
                    Looks Legit
                </button>
            </div>
        </div>

        <!-- Start/End Game Overlay -->
        <div id="game-overlay" class="absolute inset-0 bg-gray-950 bg-opacity-95 flex flex-col items-center justify-center text-center p-4 rounded-3xl">
            <h2 id="overlay-title" class="text-4xl md:text-6xl font-black text-white mb-4">Welcome to Spot the Phish</h2>
            <p id="overlay-message" class="text-lg md:text-xl text-gray-300 mb-8 max-w-prose">Test your cyber-sleuthing skills! Your goal is to identify all the clues in the fake emails. Be carefulâ€”some are real. Let's see how many you can spot!</p>
            <button id="start-button" class="px-8 py-4 rounded-full bg-purple-600 hover:bg-purple-700 text-xl font-bold text-white transition-colors duration-200">
                Start Game
            </button>
        </div>
        
        <!-- Name Submission Modal -->
        <div id="name-modal" class="absolute inset-0 bg-gray-950 bg-opacity-95 flex flex-col items-center justify-center text-center p-4 rounded-3xl hidden">
            <h2 class="text-3xl md:text-4xl font-black text-cyan-400 mb-4">Submit Your Score</h2>
            <p class="text-lg md:text-xl text-gray-300 mb-6 max-w-prose">
                Enter your name to be entered into the prize drawing!
            </p>
            <input type="text" id="player-name-input" placeholder="Your Name" class="w-full max-w-sm p-4 text-center rounded-xl bg-gray-700 text-white placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-cyan-500 mb-4">
            <button id="submit-name-button" class="px-8 py-4 rounded-full bg-purple-600 hover:bg-purple-700 text-xl font-bold text-white transition-colors duration-200">
                Submit
            </button>
        </div>
        
        <!-- Loading overlay -->
        <div id="loading-overlay" class="absolute inset-0 bg-gray-950 bg-opacity-95 flex flex-col items-center justify-center text-center p-4 rounded-3xl hidden">
            <div class="loader"></div>
            <p class="mt-4 text-gray-400 text-lg">Connecting to server...</p>
        </div>

    </div>

    <!-- Firebase SDK Imports -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection, query, limit, orderBy } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

        // IMPORTANT: YOUR FIREBASE CONFIGURATION
        const firebaseConfig = {
            apiKey: "AIzaSyCXGePW9HO2gZb-YXVOXbof_eKHv20PsNo",
            authDomain: "cyber-security-month.firebaseapp.com",
            projectId: "cyber-security-month",
            storageBucket: "cyber-security-month.firebasestorage.app",
            messagingSenderId: "798324598459",
            appId: "1:798324598459:web:a71a03d1ea30eac92aeb9e",
            measurementId: "G-39KS43N4R2" 
        };
        
        // Initialize Firebase app and services globally
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        const appId = firebaseConfig.projectId;
        let userId;
        let finalGameScore;

        const loadingOverlay = document.getElementById('loading-overlay');
        const userIdDisplay = document.getElementById('user-id-display');
        const leaderboard = document.getElementById('leaderboard');
        const nameModal = document.getElementById('name-modal');
        const playerNameInput = document.getElementById('player-name-input');
        const submitNameButton = document.getElementById('submit-name-button');
        
        const setupFirebase = async () => {
            loadingOverlay.classList.remove('hidden');
            try {
                const storedUserId = localStorage.getItem('spotThePhishUserId');
                if (storedUserId) {
                    await signInAnonymously(auth);
                } else {
                    await signInAnonymously(auth);
                }

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        localStorage.setItem('spotThePhishUserId', userId);
                        userIdDisplay.textContent = userId;
                        loadingOverlay.classList.add('hidden');
                        document.getElementById('game-overlay').classList.remove('hidden');
                        
                        listenForLeaderboard();
                    } else {
                        console.log("User signed out");
                    }
                });
            } catch (error) {
                console.error("Error initializing Firebase:", error);
                loadingOverlay.classList.add('hidden');
                document.getElementById('game-overlay').classList.remove('hidden');
                overlayTitle.textContent = "Error";
                overlayMessage.textContent = "Could not connect to the database. The game will run locally, but scores will not be saved. " + error.message;
            }
        };

        const saveScore = async () => {
            const playerName = playerNameInput.value.trim() || 'Anonymous';
            if (!userId) {
                console.error("User not authenticated. Score not saved.");
                return;
            }
            try {
                const docRef = doc(db, `scores`, userId);
                await setDoc(docRef, {
                    userId: userId,
                    score: finalGameScore,
                    name: playerName,
                    timestamp: new Date()
                });
                console.log("Score saved successfully!");
                nameModal.classList.add('hidden');
                overlay.classList.remove('hidden');
                // Force a refresh of the leaderboard to show the new score
                listenForLeaderboard();
            } catch (e) {
                console.error("Error adding document: ", e);
                nameModal.classList.add('hidden');
                overlay.classList.remove('hidden');
                showMessage('Score could not be saved to the leaderboard. Check your Firebase console for errors.', 'red');
            }
        };

        const listenForLeaderboard = () => {
            const scoresCol = collection(db, `scores`);
            // The Firebase query has been simplified to not use `orderBy` to avoid index issues
            const q = query(scoresCol, limit(10));
            onSnapshot(q, (querySnapshot) => {
                const scores = [];
                querySnapshot.forEach((doc) => {
                    scores.push(doc.data());
                });

                // The scores are now sorted in-memory after fetching all documents
                scores.sort((a, b) => b.score - a.score);

                leaderboard.innerHTML = '';
                if (scores.length === 0) {
                    leaderboard.innerHTML = '<p class="text-center text-gray-500">No scores yet. Be the first!</p>';
                } else {
                    scores.forEach((player, index) => {
                        const row = document.createElement('div');
                        row.className = 'flex justify-between items-center p-2 rounded';
                        if (player.userId === userId) {
                            row.classList.add('bg-green-700', 'bg-opacity-40', 'border', 'border-green-500');
                        }
                        const rank = index + 1;
                        row.innerHTML = `
                            <span class="font-bold w-1/12">${rank}.</span>
                            <span class="w-8/12 font-mono break-all">${player.name || player.userId.substring(0, 8) + '...'}</span>
                            <span class="w-3/12 text-right font-bold text-lg">${player.score}</span>
                        `;
                        leaderboard.appendChild(row);
                    });
                }
            });
        };

        window.addEventListener('load', setupFirebase);
        submitNameButton.addEventListener('click', saveScore);
    </script>

    <!-- JavaScript for the game logic -->
    <script>
        let score = 0;
        let currentRound = 0;
        let clickedClues = [];
        let scenarios = [];
        
        const gameUI = document.getElementById('game-ui');
        const overlay = document.getElementById('game-overlay');
        const overlayTitle = document.getElementById('overlay-title');
        const overlayMessage = document.getElementById('overlay-message');
        const startButton = document.getElementById('start-button');
        const scoreDisplay = document.getElementById('score-display');
        const roundDisplay = document.getElementById('round-display');
        const emailContainer = document.getElementById('email-container');
        const actionButton = document.getElementById('action-button');
        const hintButton = document.getElementById('hint-button');
        const nameModal = document.getElementById('name-modal');
        
        let hasClickedClue = false;
        let hasSubmitted = false;
        let hintUsedThisRound = false;

        const allScenarios = [
            {
                type: 'phishing',
                emailContent: `
                    <div class="text-base text-gray-300 space-y-4">
                        <p><strong>Subject: Important Human Resources Update: New Policies</strong></p>
                        <p>Hi team,</p>
                        <p>We're making some updates to our company's Human Resources policies. To review and acknowledge the changes, please visit our new internal portal.</p>
                        <a href="#" class="text-blue-400 underline phish-clue" data-clue="unbranded-link">Access new portal here</a>
                        <p>For your security, you must log in using your company credentials.</p>
                        <p class="phish-clue" data-clue="vague-sender">Regards,<br>HR Department</p>
                        <p><small class="text-gray-500">This is an automated notification. Please do not reply.</small></p>
                    </div>
                `,
                clues: [
                    { selector: '[data-clue="unbranded-link"]', description: 'The email links to a generic URL without any company branding in the domain.' },
                    { selector: '[data-clue="vague-sender"]', description: 'The sender is a vague "HR Department" instead of a specific person or team email address.' }
                ]
            },
            {
                type: 'phishing',
                emailContent: `
                    <div class="text-base text-gray-300 space-y-4">
                        <p><strong>Subject: Invoice #872322 is Past Due</strong></p>
                        <p>Dear Customer,</p>
                        <p>Your payment for invoice #872322 is now overdue. Please make an immediate payment to avoid additional fees.</p>
                        <p>To view the full invoice and pay, please download the attached document.<br>
                        <a href="#" class="text-blue-400 phish-clue" data-clue="suspicious-attachment">Download Invoice_872322.exe</a></p>
                        <p class="phish-clue" data-clue="no-context">If you have any questions, contact our finance department.</p>
                        <p>Thank you.</p>
                        <p>Finance Dept</p>
                    </div>
                `,
                clues: [
                    { selector: '[data-clue="suspicious-attachment"]', description: 'The file extension is ".exe" which is a suspicious executable file.' },
                    { selector: '[data-clue="no-context"]', description: 'There is no context or personalized information about the invoice.' }
                ]
            },
            {
                type: 'legit',
                emailContent: `
                    <div class="text-base text-gray-300 space-y-4">
                        <p><strong>Subject: Reminder: Building Maintenance Scheduled for Friday</strong></p>
                        <p>Hi everyone,</p>
                        <p>This is a reminder that scheduled building maintenance will take place this Friday, from 6 PM to 10 PM. During this time, you may experience brief interruptions to our network services.</p>
                        <p>No action is required on your part. We apologize for any inconvenience.</p>
                        <p>Thanks,<br>Facilities Team</p>
                    </div>
                `,
                clues: []
            },
            {
                type: 'phishing',
                emailContent: `
                    <div class="text-base text-gray-300 space-y-4">
                        <p><strong>Subject: Action Required: Your account will be suspended if you do not verify</strong></p>
                        <p>Dear User,</p>
                        <p class="phish-clue" data-clue="strong-urgency">We noticed unusual activity on your account. To protect your data, we have temporarily locked your profile.</p>
                        <p>Please click on the link below and log in to verify your identity and unlock your account immediately:</p>
                        <a href="#" class="text-blue-400 underline phish-clue" data-clue="fake-domain">https://microsoft-login.services/verify-account</a>
                        <p>If you do not verify within 24 hours, your account will be permanently closed.</p>
                        <p>Thanks,<br>The Security Team</p>
                    </div>
                `,
                clues: [
                    { selector: '[data-clue="strong-urgency"]', description: 'The tone is extremely urgent and tries to create a sense of panic to force a quick decision.' },
                    { selector: '[data-clue="fake-domain"]', description: 'The domain "microsoft-login.services" is not a legitimate Microsoft domain.' }
                ]
            },
            {
                type: 'legit',
                emailContent: `
                    <div class="text-base text-gray-300 space-y-4">
                        <p><strong>Subject: Lunch & Learn: A New Approach to Project Management</strong></p>
                        <p>Hello team,</p>
                        <p>Join us next Thursday for a Lunch & Learn session with guest speaker Jane Doe to discuss new project management strategies. Lunch will be provided.</p>
                        <p><a href="https://yourcompany.com/internal-events/signup" class="text-blue-400 underline">Register to attend</a></p>
                        <p>Hope to see you there!</p>
                        <p>Regards,<br>Learning & Development Team</p>
                    </div>
                `,
                clues: []
            }
        ];

        const shuffleArray = (array) => {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        };

        const startGame = () => {
            score = 0;
            currentRound = 0;
            clickedClues = [];
            hasClickedClue = false;
            hasSubmitted = false;
            hintUsedThisRound = false;
            
            shuffleArray(allScenarios);
            scenarios = allScenarios.slice(0, 5);

            updateUI();
            overlay.classList.add('hidden');
            gameUI.classList.remove('hidden');

            displayScenario();
        };

        const updateUI = () => {
            scoreDisplay.textContent = `Score: ${score}`;
            roundDisplay.textContent = `Round: ${currentRound + 1}/${scenarios.length}`;
            if (hasClickedClue) {
                actionButton.textContent = 'Submit Phish';
                actionButton.classList.remove('bg-blue-600', 'hover:bg-blue-700');
                actionButton.classList.add('bg-red-600', 'hover:bg-red-700');
            } else {
                actionButton.textContent = 'Looks Legit';
                actionButton.classList.remove('bg-red-600', 'hover:bg-red-700');
                actionButton.classList.add('bg-blue-600', 'hover:bg-blue-700');
            }
            actionButton.disabled = hasSubmitted;
            actionButton.classList.toggle('cursor-not-allowed', hasSubmitted);
            actionButton.classList.toggle('opacity-50', hasSubmitted);
            
            hintButton.disabled = hintUsedThisRound;
            hintButton.classList.toggle('cursor-not-allowed', hintUsedThisRound);
            hintButton.classList.toggle('opacity-50', hintUsedThisRound);
        };

        const displayScenario = () => {
            if (currentRound >= scenarios.length) {
                endGame();
                return;
            }

            emailContainer.innerHTML = '';
            emailContainer.classList.remove('pointer-events-none');
            
            hasClickedClue = false;
            hasSubmitted = false;
            hintUsedThisRound = false;

            const currentScenario = scenarios[currentRound];
            emailContainer.innerHTML = currentScenario.emailContent;

            emailContainer.querySelectorAll('.phish-clue').forEach(clueEl => {
                clueEl.addEventListener('click', (e) => handleClueClick(e, clueEl));
            });
            updateUI();
        };

        const handleClueClick = (e, clueEl) => {
            e.preventDefault(); 
            if (hasSubmitted) return;

            const currentScenario = scenarios[currentRound];
            const clueData = clueEl.getAttribute('data-clue');
            const foundClue = currentScenario.clues.find(c => c.selector.includes(clueData));

            if (foundClue && !clickedClues.includes(clueData)) {
                clueEl.classList.add('correct-answer');
                clueEl.style.textDecoration = 'line-through';
                score += 10;
                clickedClues.push(clueData);
                showMessage('Correct! ' + foundClue.description, 'green');
            } else if (!foundClue) {
                clueEl.classList.add('incorrect-answer');
                score = Math.max(0, score - 5);
                showMessage('That\'s not a clue. Be careful!', 'red');
            }
            
            hasClickedClue = true;
            updateUI();
        };

        const handleAction = () => {
            if (hasSubmitted) return;
            hasSubmitted = true;
            emailContainer.classList.add('pointer-events-none');

            const currentScenario = scenarios[currentRound];
            const allCluesFound = clickedClues.length === currentScenario.clues.length;

            if (currentScenario.type === 'legit') {
                 if (hasClickedClue) {
                     score = Math.max(0, score - 20);
                     showMessage('Incorrect. This was a legitimate email. Do not click on clues.', 'red');
                 } else {
                     score += 20;
                     showMessage('Correct! This email looks legit.', 'green');
                 }
            } else {
                 if (allCluesFound) {
                     score += 10;
                     showMessage('Great job! You found all the clues.', 'green');
                 } else {
                     score = Math.max(0, score - 15);
                     showMessage(`Oops! You missed some clues. The correct answers were highlighted.`, 'red');
                     currentScenario.clues.forEach(clue => {
                         const clueEl = emailContainer.querySelector(clue.selector);
                         if (clueEl && !clueEl.classList.contains('correct-answer')) {
                            clueEl.classList.add('incorrect-answer');
                         }
                     });
                 }
            }
            
            actionButton.textContent = 'Next Email';
            actionButton.disabled = false;
            actionButton.classList.remove('bg-blue-600', 'hover:bg-blue-700', 'bg-red-600', 'hover:bg-red-700');
            actionButton.classList.add('bg-green-600', 'hover:bg-green-700');
            actionButton.onclick = () => {
                currentRound++;
                clickedClues = [];
                hasSubmitted = false;
                displayScenario();
            };
        };

        const handleHint = () => {
            if (hintUsedThisRound || hasSubmitted) return;
            
            const currentScenario = scenarios[currentRound];
            const unclickedClues = currentScenario.clues.filter(clue => !clickedClues.includes(clue.selector.replace('[data-clue="', '').replace('"]', '')));
            
            if (unclickedClues.length > 0) {
                const firstUnclickedClue = unclickedClues[0];
                const clueEl = emailContainer.querySelector(firstUnclickedClue.selector);
                
                clueEl.classList.add('hint-highlight');
                score = Math.max(0, score - 5);
                showMessage(`Hint used! A clue has been highlighted.`, 'yellow');
                
                hintUsedThisRound = true;
                updateUI();
            } else {
                showMessage('No more clues to find!', 'gray');
            }
        };

        const showMessage = (msg, color) => {
            const messageBox = document.createElement('div');
            messageBox.textContent = msg;
            messageBox.className = `p-4 rounded-lg mt-4 text-center font-bold text-lg transition-all duration-300`;
            
            if (color === 'green') {
                messageBox.classList.add('bg-green-600', 'text-white', 'shadow-md');
            } else if (color === 'red') {
                messageBox.classList.add('bg-red-600', 'text-white', 'shadow-md');
            } else if (color === 'yellow') {
                messageBox.classList.add('bg-yellow-500', 'text-gray-900', 'shadow-md');
            }
            
            emailContainer.prepend(messageBox);
            setTimeout(() => {
                messageBox.remove();
            }, 3000);
        };

        const endGame = () => {
            gameUI.classList.add('hidden');
            overlay.classList.add('hidden');
            nameModal.classList.remove('hidden');
            
            window.finalGameScore = score;
        };

        startButton.addEventListener('click', startGame);
        actionButton.addEventListener('click', handleAction);
        hintButton.addEventListener('click', handleHint);
        
        window.addEventListener('load', () => {
            gameUI.classList.add('hidden');
            overlay.classList.add('hidden');
            nameModal.classList.add('hidden');
        });

    </script>
</body>
</html>
